{% extends "layout.njk" %}
{% import "macros.njk" as macros %}

{% block main %}
{{ imports }}
{% if withPostgres and postgresMode !== 'generic' %}
#[cfg(feature = "postgres")]
pub mod postgres;
{% endif %}

{% if withGraphQL %}
#[cfg(feature = "graphql")]
pub mod graphql;
{% endif %}

{% for instruction in instructionsToExport | sort(false, false, 'name') %}
pub mod {{ macros.escapeRustKeyword(instruction.name | snakeCase) }};
{% endfor %}
{% if hasAnchorEvents %}
pub mod cpi_event;
{% endif %}

{% for instruction in instructionsToExport | sort(false, false, 'name') %}
pub use self::{{ macros.escapeRustKeyword(instruction.name | snakeCase) }}::*;
{% endfor %}
{% if hasAnchorEvents %}
pub use self::cpi_event::*;
{% endif %}

{{ macros.enumWrapperDerives() }}
pub enum {{ program.name | pascalCase }}Instruction {
{% for instruction in instructionsToExport | sort(false, false, 'name') %}
    {{ instruction.name | pascalCase }} {
        program_id: solana_pubkey::Pubkey,
        data: {{ instruction.name | pascalCase }},
        accounts: {{ instruction.name | pascalCase }}InstructionAccounts,
    },
{% endfor %}
{% if hasAnchorEvents %}
    // Anchor CPI Event Instruction
    CpiEvent {
        program_id: solana_pubkey::Pubkey,
        data: CpiEvent,
        accounts: CpiEventInstructionAccounts,
    },
{% endif %}
}

impl carbon_core::instruction::InstructionDecoder<'_> for {{ program.name | pascalCase }}Decoder {
    type InstructionType = {{ program.name | pascalCase }}Instruction;

    fn decode_instruction(
        &self,
        instruction: &solana_instruction::Instruction,
    ) -> Option<Self::InstructionType> {
        if instruction.program_id != PROGRAM_ID {
            return None;
        }

        carbon_core::try_decode_instructions!(
            instruction,
            PROGRAM_ID,
{% for instruction in instructionsToExport | sort(false, false, 'name') %}
            {{ program.name | pascalCase }}Instruction::{{ instruction.name | pascalCase }} => {{ instruction.name | pascalCase }},
{% endfor %}
{% if hasAnchorEvents %}
            {{ program.name | pascalCase }}Instruction::CpiEvent => CpiEvent,
{% endif %}
        )
    }
}
{% endblock %}