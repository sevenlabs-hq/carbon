//! This code was AUTOGENERATED using the Codama library.
pub mod bonding_curve_row;
pub mod fee_config_row;
pub mod global_row;
pub mod global_volume_accumulator_row;
pub mod user_volume_accumulator_row;

pub use self::{
    bonding_curve_row::*, fee_config_row::*, global_row::*, global_volume_accumulator_row::*,
    user_volume_accumulator_row::*,
};
use super::PumpfunAccount;

pub struct PumpfunAccountsMigration;

impl sqlx_migrator::Migration<sqlx::Postgres> for PumpfunAccountsMigration {
    fn app(&self) -> &str {
        "pumpfun"
    }

    fn name(&self) -> &str {
        "pumpfun_accounts"
    }

    fn operations(&self) -> Vec<Box<dyn sqlx_migrator::Operation<sqlx::Postgres>>> {
        vec![
            Box::new(BondingCurveMigrationOperation),
            Box::new(FeeConfigMigrationOperation),
            Box::new(GlobalMigrationOperation),
            Box::new(GlobalVolumeAccumulatorMigrationOperation),
            Box::new(UserVolumeAccumulatorMigrationOperation),
        ]
    }

    fn parents(&self) -> Vec<Box<dyn sqlx_migrator::Migration<sqlx::Postgres>>> {
        vec![]
    }
}

pub struct PumpfunAccountWithMetadata(
    pub PumpfunAccount,
    pub carbon_core::account::AccountMetadata,
);

impl From<(PumpfunAccount, carbon_core::account::AccountMetadata)> for PumpfunAccountWithMetadata {
    fn from(value: (PumpfunAccount, carbon_core::account::AccountMetadata)) -> Self {
        PumpfunAccountWithMetadata(value.0, value.1)
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Insert for PumpfunAccountWithMetadata {
    async fn insert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let PumpfunAccountWithMetadata(account, metadata) = self;

        match account {
            PumpfunAccount::BondingCurve(account) => {
                let row = bonding_curve_row::BondingCurveRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            PumpfunAccount::FeeConfig(account) => {
                let row =
                    fee_config_row::FeeConfigRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            PumpfunAccount::Global(account) => {
                let row = global_row::GlobalRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            PumpfunAccount::GlobalVolumeAccumulator(account) => {
                let row = global_volume_accumulator_row::GlobalVolumeAccumulatorRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            PumpfunAccount::UserVolumeAccumulator(account) => {
                let row = user_volume_accumulator_row::UserVolumeAccumulatorRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
        }
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Upsert for PumpfunAccountWithMetadata {
    async fn upsert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let PumpfunAccountWithMetadata(account, metadata) = self;
        match account {
            PumpfunAccount::BondingCurve(account) => {
                let row = bonding_curve_row::BondingCurveRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            PumpfunAccount::FeeConfig(account) => {
                let row =
                    fee_config_row::FeeConfigRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            PumpfunAccount::Global(account) => {
                let row = global_row::GlobalRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            PumpfunAccount::GlobalVolumeAccumulator(account) => {
                let row = global_volume_accumulator_row::GlobalVolumeAccumulatorRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            PumpfunAccount::UserVolumeAccumulator(account) => {
                let row = user_volume_accumulator_row::UserVolumeAccumulatorRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
        }
    }
}
