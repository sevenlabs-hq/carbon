//! This code was AUTOGENERATED using the Codama library.
pub mod config_row;
pub mod operator_row;
pub mod pod_aligned_fee_market_cap_scheduler_row;
pub mod pod_aligned_fee_rate_limiter_row;
pub mod pod_aligned_fee_time_scheduler_row;
pub mod pool_row;
pub mod position_row;
pub mod token_badge_row;
pub mod vesting_row;

pub use self::{
    config_row::*, operator_row::*, pod_aligned_fee_market_cap_scheduler_row::*,
    pod_aligned_fee_rate_limiter_row::*, pod_aligned_fee_time_scheduler_row::*, pool_row::*,
    position_row::*, token_badge_row::*, vesting_row::*,
};
use super::MeteoraDammV2Account;

pub struct MeteoraDammV2AccountsMigration;

impl sqlx_migrator::Migration<sqlx::Postgres> for MeteoraDammV2AccountsMigration {
    fn app(&self) -> &str {
        "meteora-damm-v2"
    }

    fn name(&self) -> &str {
        "meteora_damm_v2_accounts"
    }

    fn operations(&self) -> Vec<Box<dyn sqlx_migrator::Operation<sqlx::Postgres>>> {
        vec![
            Box::new(ConfigMigrationOperation),
            Box::new(OperatorMigrationOperation),
            Box::new(PodAlignedFeeMarketCapSchedulerMigrationOperation),
            Box::new(PodAlignedFeeRateLimiterMigrationOperation),
            Box::new(PodAlignedFeeTimeSchedulerMigrationOperation),
            Box::new(PoolMigrationOperation),
            Box::new(PositionMigrationOperation),
            Box::new(TokenBadgeMigrationOperation),
            Box::new(VestingMigrationOperation),
        ]
    }

    fn parents(&self) -> Vec<Box<dyn sqlx_migrator::Migration<sqlx::Postgres>>> {
        vec![]
    }
}

pub struct MeteoraDammV2AccountWithMetadata(
    pub MeteoraDammV2Account,
    pub carbon_core::account::AccountMetadata,
);

impl From<(MeteoraDammV2Account, carbon_core::account::AccountMetadata)>
    for MeteoraDammV2AccountWithMetadata
{
    fn from(value: (MeteoraDammV2Account, carbon_core::account::AccountMetadata)) -> Self {
        MeteoraDammV2AccountWithMetadata(value.0, value.1)
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Insert for MeteoraDammV2AccountWithMetadata {
    async fn insert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let MeteoraDammV2AccountWithMetadata(account, metadata) = self;

        match account {
            MeteoraDammV2Account::Config(account) => {
                let row = config_row::ConfigRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Operator(account) => {
                let row = operator_row::OperatorRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::PodAlignedFeeMarketCapScheduler(account) => {
                let row = pod_aligned_fee_market_cap_scheduler_row::PodAlignedFeeMarketCapSchedulerRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::PodAlignedFeeRateLimiter(account) => {
                let row = pod_aligned_fee_rate_limiter_row::PodAlignedFeeRateLimiterRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::PodAlignedFeeTimeScheduler(account) => {
                let row =
                    pod_aligned_fee_time_scheduler_row::PodAlignedFeeTimeSchedulerRow::from_parts(
                        *account.clone(),
                        metadata.clone(),
                    );
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Pool(account) => {
                let row = pool_row::PoolRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Position(account) => {
                let row = position_row::PositionRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::TokenBadge(account) => {
                let row =
                    token_badge_row::TokenBadgeRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Vesting(account) => {
                let row = vesting_row::VestingRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
        }
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Upsert for MeteoraDammV2AccountWithMetadata {
    async fn upsert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let MeteoraDammV2AccountWithMetadata(account, metadata) = self;
        match account {
            MeteoraDammV2Account::Config(account) => {
                let row = config_row::ConfigRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Operator(account) => {
                let row = operator_row::OperatorRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::PodAlignedFeeMarketCapScheduler(account) => {
                let row = pod_aligned_fee_market_cap_scheduler_row::PodAlignedFeeMarketCapSchedulerRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::PodAlignedFeeRateLimiter(account) => {
                let row = pod_aligned_fee_rate_limiter_row::PodAlignedFeeRateLimiterRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::PodAlignedFeeTimeScheduler(account) => {
                let row =
                    pod_aligned_fee_time_scheduler_row::PodAlignedFeeTimeSchedulerRow::from_parts(
                        *account.clone(),
                        metadata.clone(),
                    );
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Pool(account) => {
                let row = pool_row::PoolRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Position(account) => {
                let row = position_row::PositionRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::TokenBadge(account) => {
                let row =
                    token_badge_row::TokenBadgeRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            MeteoraDammV2Account::Vesting(account) => {
                let row = vesting_row::VestingRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
        }
    }
}
